{% load static %}

<!DOCTYPE html>
<html style="height: 100%;">
<head>
<link rel="stylesheet" type="text/css" href="{% static "css/bootstrap.css" %}">
<link rel="stylesheet" type="text/css" href="{% static "css/pajeet.css" %}">
   <title></title>
</head>
<body class="fill">

<!-- jQuery -->
<script src="{% static "js/jquery.js" %}"></script>

<!-- Bootstrap Core JavaScript -->
<script src="{% static "js/bootstrap.min.js" %}"></script>

<div class="main_section fill">
   <div class="fill">
      <div class="chat_container fill">
         <div class="col-sm-3 chat_sidebar fill">
         <div class="row">
            <div id="custom-search-input">
               <div class="input-group col-md-12">
                  <input type="text" class="  search-query form-control" placeholder="Conversation" />
                  <button class="btn btn-danger" type="button">
                  <span class=" glyphicon glyphicon-search"></span>
                  </button>
               </div>
            </div>
            <div class="dropdown all_conversation">
               <button class="dropdown-toggle" type="button" id="dropdownMenu2" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
               <i class="fa fa-weixin" aria-hidden="true"></i>
               All Conversations
               <span class="caret pull-right"></span>
               </button>
               <ul class="dropdown-menu" aria-labelledby="dropdownMenu2">
                  <li><a href="#"> All Conversation </a>  <ul class="sub_menu_ list-unstyled">
                  <li><a href="#"> All Conversation </a> </li>
                  <li><a href="#">Another action</a></li>
                  <li><a href="#">Something else here</a></li>
                  <li><a href="#">Separated link</a></li>
               </ul>
               </li>
                  <li><a href="#">Another action</a></li>
                  <li><a href="#">Something else here</a></li>
                  <li><a href="#">Separated link</a></li>
               </ul>
            </div>
            <div class="member_list">
               <ul class="list-unstyled">
                  {% for room in rooms %}
                  <li class="left clearfix" id="{{ room.pk }}">
                     <span class="chat-img pull-left">
                     <img src="{{ room.image.url }}" class="img-circle">
                     </span>
                     <div class="chat-body clearfix">
                        <div class="header_sec">
                           <strong class="primary-font">{{ room.name }}</strong> <strong class="pull-right">
                           {{ room.latest_message.created_at }}</strong>
                        </div>
                        <div class="contact_sec">
                           <strong class="primary-font" id="latest{{ room.pk }}">{{ room.latest_message.author }}: {{ room.latest_message.text }}</strong> <span class="badge pull-right">3</span>
                        </div>
                     </div>
                  </li>
                  {% endfor %}
               </ul>
            </div></div>
         </div>
         <!--chat_sidebar-->
         
         
         <div class="col-sm-9 message_section fill">
         <div class="row fill">
         <div class="new_message_head">
         <div class="pull-right"><div class="dropdown">
  <button class="dropdown-toggle" type="button" id="dropdownMenu1" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
    <i class="fa fa-cogs" aria-hidden="true"></i>Setting
    <span class="caret"></span>
  </button>
  <ul class="dropdown-menu dropdown-menu-right" aria-labelledby="dropdownMenu1">
    <li><a id="profile">Profile</a></li>
    <li><a href="signout">Logout</a></li>
  </ul>
</div></div>
         </div><!--new_message_head-->
         
         <div class="chat_area wrapper" id="chat_area">
            <div class="vcenter"><p class="text-center text-muted">Click on a chat to start messaging...</p></div>
         </div><!--chat_area-->
         
         <div class="message_write">
            <div class="row">
               <div class="col-xs-9">
                  <textarea class="form-control" placeholder="type a message" id="message_text" name="message_text"></textarea>
               </div>
               <div class="col-xs-3 fill">
                  <a class="btn btn-success vcenter" id="send_button">Send</a>
               </div>
            </div>

         </div>
      </div>
         </div>
         </div> <!--message_section-->
      </div>
   </div>
</div>

<script type="text/javascript">
   var username = "{{ request.user.username }}"
   var i;
   {% for room in rooms %}

   var socket{{ room.pk }} = new WebSocket("ws://" + window.location.host + "/chat/" + "{{ room.pk }}" + "?username=" + username);

   var messages{{ room.pk }} = ''

   var my_profile = ''

   $.get(window.location.href + "chat/{{ room.pk }}/", function(data) {
      messages{{ room.pk }} += data
   })
   
   $.get(window.location.href + "profile/{{ request.user.username }}/", function(data) {
      my_profile = data
   })

   socket{{ room.pk }}.onmessage = function(e) {

            data = JSON.parse(e.data);
            var html = '<li class=\"left clearfix\"><span class=\"chat-img '
            if(username == data.user) {
               html += 'pull-left">'
            } else {
               html += 'pull-right">'
            }

            html += ' <img src=' + window.location.href + 'image/' 
            + data.user
            + '/ class=\"img-circle\"></span><div class=\"chat-body1 clearfix\"><p>'
            + data.content 
            + '</p><div class=\"chat_time pull-right\">' 
            + new Date().toISOString().replace('T', ' ').slice(0,19) + '</div></div></li>'
            messages{{ room.pk }} += html;
            $("#latest{{ room.pk }}").html(data.user + ': ' + data.content)
         
         if(i=={{ room.pk }}) {         
               $("#messages").append(html);
               var objDiv = document.getElementById("chat_area");
               objDiv.scrollTop = objDiv.scrollHeight;
         }
   }

   function sendMessage{{ room.pk }}() {
        var msg = {
            type: "message",
            room: {{ room.pk }},
            msg: document.getElementById("message_text").value
        }
        socket{{ room.pk }}.send(JSON.stringify(msg));
        $("#message_text").val('');
    }
   

   $("#{{ room.pk }}").click(function(e) {
        e.preventDefault();
        i = {{ room.pk }}
        //alert(window.location.href + "chat/{{ room.pk }}/")
        
         $("#chat_area").html('<ul class="list-unstyled" id="messages">'
            + messages{{ room.pk }}
            + '   </ul>');
         var objDiv = document.getElementById("chat_area");
         objDiv.scrollTop = objDiv.scrollHeight;

        $("#send_button").attr("onclick", "javascript: sendMessage{{ room.pk }}();");
        $("#message_text").focus();

    });
    

    {% endfor %}
    $(document).keypress(function(e){
    if (e.which == 13 && !e.shiftKey){
        e.preventDefault();
        $("#send_button").click();
    }
});

    $("#profile").click(function(e) {
      $("#chat_area").html(my_profile)
    })
</script>

</body>
</html>